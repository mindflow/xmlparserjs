import{Logger as t,Map as e,StringUtils as n,List as s}from"./coreutil_v1.js";class r{static read(t,e,n,s=!1){let r=n;for(let n=0;n<e.length&&n<t.length;n++){for(;s&&" "==t.charAt(r);)r++;if(t.charAt(r)!=e.charAt(n))return-1;r++}return r-1}}class i{constructor(t,e,n){this.name=t,this.namespace=e,this.value=n}}const l=new t("ElementBody");class a{constructor(){this.name=null,this.namespace=null,this.attributes=new e}detectPositions(t,e,s){let r=s,i=null;for(;n.isInAlphabet(e.charAt(s))&&s<e.length;)s++;if(":"==e.charAt(s))for(l.debug(t,"Found namespace"),s++;n.isInAlphabet(e.charAt(s))&&s<e.length;)s++;return i=s-1,this.name=e.substring(r,i+1),this.name.indexOf(":")>-1&&(this.namespace=this.name.split(":")[0],this.name=this.name.split(":")[1]),s=this.detectAttributes(t,e,s)}detectAttributes(t,e,n){let s=null;for(;-1!=(s=this.detectNextStartAttribute(t,e,n));){n=this.detectNextEndAttribute(t,e,s);let r=null,i=e.substring(s,n+1);i.indexOf(":")>-1&&(r=i.split(":")[0],i=i.split(":")[1]),l.debug(t,"Found attribute from "+s+"  to "+n),n=this.detectValue(i,r,t,e,n+1)}return n}detectNextStartAttribute(t,e,s){for(;" "==e.charAt(s)&&s<e.length;)if(s++,n.isInAlphabet(e.charAt(s))||"-"===e.charAt(s))return s;return-1}detectNextEndAttribute(t,e,s){for(;n.isInAlphabet(e.charAt(s))||"-"===e.charAt(s);)s++;if(":"==e.charAt(s))for(s++;n.isInAlphabet(e.charAt(s))||"-"===e.charAt(s);)s++;return s-1}detectValue(t,e,n,s,a){let o=a,u=t;if(null!==e&&(u=e+":"+t),-1==(o=r.read(s,'="',o,!0)))return this.attributes.set(u,new i(t,e,null)),a;o++,l.debug(n,"Possible attribute value start at "+o);let h=o;for(;this.isAttributeContent(n,s,o);)o++;return o==a?this.attributes.set(u,new i(t,e,"")):this.attributes.set(u,new i(t,e,s.substring(h,o))),l.debug(n,"Found attribute content ending at "+(o-1)),-1!=(o=r.read(s,'"',o,!0))?o++:l.error("Missing end quotes on attribute at position "+o),o}isAttributeContent(t,e,n){return-1==r.read(e,"<",n)&&(-1==r.read(e,">",n)&&-1==r.read(e,'"',n))}}const o=new t("XmlCdata");class u{constructor(t){this.value=t}dump(){this.dumpLevel(0)}dumpLevel(t){let e=":";for(let n=0;n<2*t;n++)e+=" ";o.info(e+this.value)}read(){return this.value}}const h=new t("XmlElement");class c{constructor(t,n,r,i){this.name=t,this.namespace=n,this.selfClosing=i,this.childElements=new s,this.attributes=new e,this.namespaceUri=r}get fullName(){return null===this.namespace?this.name:this.namespace+":"+this.name}setAttribute(t,e){this.attributes.set(t,e)}getAttribute(t){return this.attributes.get(t)}containsAttribute(t){return this.attributes.contains(t)}clearAttribute(){this.attributes=new e}setText(t){this.childElements=new s,this.addText(t)}addText(t){let e=new u(t);this.childElements.add(e)}dump(){this.dumpLevel(0)}dumpLevel(t){let e=":";for(let n=0;n<2*t;n++)e+=" ";this.selfClosing?h.info(e+"<"+this.fullName+this.readAttributes()+"/>"):(h.info(e+"<"+this.fullName+this.readAttributes()+">"),this.childElements.forEach((function(e){return e.dumpLevel(t+1),!0})),h.info(e+"</"+this.fullName+">"))}read(){let t="";return this.selfClosing?(t=t+"<"+this.fullName+this.readAttributes()+"/>",t):(t=t+"<"+this.fullName+this.readAttributes()+">",this.childElements.forEach((function(e){return t+=e.read(),!0})),t=t+"</"+this.fullName+">",t)}readAttributes(){let t="";return this.attributes.forEach((function(e,n,s){let r=n.name;return null!==n.namespace&&void 0!==n.namespace&&(r=n.namespace+":"+n.name),t=t+" "+r,null!==n.value&&(t=t+'="'+n.value+'"'),!0}),this),t}}const d=new t("ElementDetector");class m{constructor(t){this.type="ElementDetector",this.namespaceUriMap=t,this.children=!1,this.found=!1,this.xmlCursor=null,this.element=null}createElement(){return this.element}isFound(){return this.found}hasChildren(){return this.children}detect(t,e){this.xmlCursor=e,d.debug(t,"Looking for opening element at position "+e.cursor);let n=new a,s=m.detectOpenElement(t,e.xml,e.cursor,n);if(-1!=s){let r=null;null!==n.namespace&&void 0!==n.namespace&&(r=this.namespaceUriMap.get(n.namespace)),this.element=new c(n.name,n.namespace,r,!1),n.attributes.forEach((function(t,e,n){return n.element.attributes.set(t,e),!0}),this),d.debug(t,"Found opening tag <"+this.element.fullName+"> from "+e.cursor+" to "+s),e.cursor=s+1,this.stop(t)||(this.children=!0),this.found=!0}}stop(t){d.debug(t,"Looking for closing element at position "+this.xmlCursor.cursor);let e=m.detectEndElement(t,this.xmlCursor.xml,this.xmlCursor.cursor);if(-1!=e){let n=this.xmlCursor.xml.substring(this.xmlCursor.cursor+2,e);return d.debug(t,"Found closing tag </"+n+"> from "+this.xmlCursor.cursor+" to "+e),this.element.fullName!=n&&d.error("ERR: Mismatch between opening tag <"+this.element.fullName+"> and closing tag </"+n+"> When exiting to parent elemnt"),this.xmlCursor.cursor=e+1,!0}return!1}static detectOpenElement(t,e,n,s){return-1==(n=r.read(e,"<",n))?-1:(n++,n=s.detectPositions(t+1,e,n),-1==(n=r.read(e,">",n,!0))?-1:n)}static detectEndElement(t,e,n){return-1==(n=r.read(e,"</",n))?-1:(n++,n=(new a).detectPositions(t+1,e,n),-1==(n=r.read(e,">",n,!0))?-1:n)}}const f=new t("CdataDetector");class p{constructor(){this.type="CdataDetector",this.value=null,this.found=!1}isFound(){return this.found}createElement(){return new u(this.value)}detect(t,e){this.found=!1,this.value=null;let n=this.detectContent(t,e.xml,e.cursor,e.parentDomScaffold);-1!=n&&(this.found=!0,this.hasChildren=!1,this.value=e.xml.substring(e.cursor,n),e.cursor=n)}detectContent(t,e,n,s){f.debug(t,"Cdata start at "+n);let r=n;if(!p.isContent(t,e,n))return f.debug(t,"No Cdata found"),-1;for(;p.isContent(t,e,n)&&n<e.length;)n++;return f.debug(t,"Cdata end at "+(n-1)),null===s?(f.error("ERR: Content not allowed on root level in xml document"),-1):(f.debug(t,"Cdata found value is "+e.substring(r,n)),n)}static isContent(t,e,n){return-1==r.read(e,"<",n)&&-1==r.read(e,">",n)}}const g=new t("ClosingElementDetector");class b{constructor(t){this.type="ClosingElementDetector",this.namespaceUriMap=t,this.found=!1,this.element=null}createElement(){return this.element}isFound(){return this.found}detect(t,e){g.debug(t,"Looking for self closing element at position "+e.cursor);let n=new a,s=b.detectClosingElement(t,e.xml,e.cursor,n);-1!=s&&(this.element=new c(n.name,n.namespace,this.namespaceUriMap,!0),n.attributes.forEach((function(t,e,n){return n.element.setAttribute(t,e),!0}),this),g.debug(t,"Found self closing tag <"+this.element.fullName+"/> from "+e.cursor+" to "+s),this.found=!0,e.cursor=s+1)}static detectClosingElement(t,e,n,s){return-1==(n=r.read(e,"<",n))?-1:(n++,n=s.detectPositions(t+1,e,n),-1==(n=r.read(e,"/>",n))?-1:n)}}class C{constructor(t,e,n){this.xml=t,this.cursor=e,this.parentDomScaffold=n}eof(){return this.cursor>=this.xml.length}}const E=new t("DomScaffold");class A{constructor(t){this.namespaceUriMap=t,this.element=null,this.childDomScaffolds=new s,this.detectors=new s,this.elementCreatedListener=null,this.detectors.add(new m(this.namespaceUriMap)),this.detectors.add(new p),this.detectors.add(new b(this.namespaceUriMap))}load(t,e,n){let s=new C(t,e,null);this.loadDepth(1,s,n)}loadDepth(t,n,s){if(E.showPos(n.xml,n.cursor),E.debug(t,"Starting DomScaffold"),this.elementCreatedListener=s,n.eof())return E.debug(t,"Reached eof. Exiting"),!1;var r=null;if(this.detectors.forEach((function(e,s){return E.debug(t,"Starting "+e.type),e.detect(t+1,n),!e.isFound()||(r=e,!1)}),this),null===r&&(n.cursor++,E.warn("WARN: No handler was found searching from position: "+n.cursor)),this.element=r.createElement(),r instanceof m&&r.hasChildren()){let s=new e;for(s.addAll(this.namespaceUriMap),this.element.attributes.forEach((function(t,e,n){"xmlns"===e.namespace&&s.set(e.name,e.value)}),this);!r.stop(t+1)&&n.cursor<n.xml.length;){let e=n.parentDomScaffold,r=new A(s);n.parentDomScaffold=r,r.loadDepth(t+1,n,this.elementCreatedListener),this.childDomScaffolds.add(r),n.parentDomScaffold=e}}E.showPos(n.xml,n.cursor)}getTree(t){if(null===this.element)return null;let e=this.notifyElementCreatedListener(this.element,t);return this.childDomScaffolds.forEach((function(t,n){let s=t.getTree(e);return null!==s&&n.element.childElements.add(s),!0}),this),this.element}notifyElementCreatedListener(t,e){return null!==this.elementCreatedListener&&void 0!==this.elementCreatedListener?this.elementCreatedListener.elementCreated(t,e):null}}class w{constructor(t,e){this.elementCreatedListener=e,this.xml=t,this.rootElement=null}load(){let t=new A(new e);t.load(this.xml,0,this.elementCreatedListener),this.rootElement=t.getTree()}dump(){this.rootElement.dump()}read(){return this.rootElement.read()}}export{p as CdataDetector,b as ClosingElementDetector,A as DomScaffold,w as DomTree,a as ElementBody,m as ElementDetector,r as ReadAhead,i as XmlAttribute,u as XmlCdata,C as XmlCursor,c as XmlElement};
